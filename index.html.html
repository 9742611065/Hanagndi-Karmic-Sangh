<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hanagandi Karmic Sang - Union Management</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #1e3a8a;
            --secondary: #f59e0b;
            --accent: #047857;
            --light: #f0f9ff;
        }
        
        .kannada-font {
            font-family: 'Noto Sans Devanagari', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-4px);
        }
        
        .header-gradient {
            background: linear-gradient(135deg, var(--primary) 0%, #0c4a6e 100%);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #0c4a6e 100%);
            color: white;
            border-radius: 12px;
            font-weight: 600;
            padding: 12px 24px;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(30, 58, 138, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #d97706 100%);
            color: white;
            border-radius: 12px;
            font-weight: 600;
            padding: 12px 24px;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(245, 158, 11, 0.3);
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .id-card {
            width: 340px;
            height: 220px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .receipt {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .work-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .work-type-option {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .work-type-option:hover {
            background: #f0f9ff;
            border-color: var(--primary);
        }
        
        .work-type-option.selected {
            background: #dbeafe;
            border-color: var(--primary);
            font-weight: 600;
        }
        
        .nav-item {
            padding: 12px 20px;
            border-radius: 12px;
            transition: all 0.2s;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }
        
        .member-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .member-table th {
            background: #f8fafc;
            padding: 16px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .member-table td {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .member-table tr:last-child td {
            border-bottom: none;
        }
        
        .action-btn {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .view-btn {
            background: #dbeafe;
            color: var(--primary);
        }
        
        .view-btn:hover {
            background: #bfdbfe;
        }
        
        .approve-btn {
            background: #dcfce7;
            color: #166534;
        }
        
        .approve-btn:hover {
            background: #bbf7d0;
        }
        
        .reject-btn {
            background: #fee2e2;
            color: #b91c1c;
        }
        
        .reject-btn:hover {
            background: #fecaca;
        }
        
        .renew-btn {
            background: #ffedd5;
            color: #9a3412;
        }
        
        .renew-btn:hover {
            background: #fed7aa;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .required::after {
            content: " *";
            color: #ef4444;
        }
        
        .id-photo {
            width: 100px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e2e8f0;
        }
        
        .print-only {
            display: none;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .print-container, .print-container * {
                visibility: visible;
            }
            .print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block;
            }
        }
        
        /* Camera capture styles */
        #camera-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #camera-preview {
            max-width: 100%;
            max-height: 70vh;
        }
        
        .camera-controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }
        
        .camera-btn {
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        
        .capture-btn {
            background: #3b82f6;
        }
        
        .cancel-camera-btn {
            background: #ef4444;
        }

        /* New styles for fixes */
        .whatsapp-btn {
            background: #25D366;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }
        
        .whatsapp-btn:hover {
            background: #128C7E;
            transform: translateY(-2px);
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        .status-approved {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .status-inactive {
            background-color: #f3f4f6;
            color: #6b7280;
        }
        
        .status-expired {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        
        .active-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .active-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #10b981;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* New styles for photo upload */
        .photo-upload-container {
            position: relative;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .photo-upload-container:hover {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }
        
        .photo-upload-container i {
            font-size: 3rem;
            color: #94a3b8;
            margin-bottom: 10px;
        }
        
        .photo-upload-container .upload-text {
            color: #64748b;
            margin-bottom: 15px;
        }
        
        .photo-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .photo-preview {
            max-width: 100%;
            max-height: 180px;
            border-radius: 8px;
            display: none;
        }
        
        /* Refresh button */
        .refresh-btn {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        /* New styles for UI enhancements */
        .hero-section {
            background: linear-gradient(rgba(30, 58, 138, 0.85), rgba(15, 23, 42, 0.9)), url('https://images.unsplash.com/photo-1504384308090-c894fdcc538d?q=80&w=2070') no-repeat center center/cover;
            padding: 80px 20px;
            color: white;
            text-align: center;
            border-radius: 16px;
        }
        
        .feature-card {
            transition: all 0.3s ease;
            border-left: 4px solid var(--secondary);
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            position: relative;
            display: inline-block;
            margin-bottom: 30px;
            padding-bottom: 10px;
        }
        
        .section-title:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: var(--secondary);
            border-radius: 2px;
        }
        
        .form-label {
            font-weight: 600;
            color: #334155;
            margin-bottom: 8px;
            display: block;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .form-control:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            outline: none;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .member-card {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        .member-card-header {
            background: var(--primary);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .member-card-body {
            padding: 20px;
            background: white;
        }
        
        .member-card-footer {
            padding: 15px 20px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
        
        .admin-panel {
            background: url('https://images.unsplash.com/photo-1553877522-43269d4ea984?q=80&w=2070') no-repeat center center/cover;
            border-radius: 16px;
            overflow: hidden;
        }
        
        .admin-panel:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.9);
        }
        
        .sidebar {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
        }
        
        /* New styles for payment records */
        .payment-record {
            border-bottom: 1px solid #e2e8f0;
            padding: 12px 0;
        }
        
        .payment-record:last-child {
            border-bottom: none;
        }
        
        .payment-type-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .payment-registration {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .payment-renewal {
            background: #dcfce7;
            color: #166534;
        }
        
        .payment-filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .payment-filter-btn {
            padding: 6px 12px;
            border-radius: 6px;
            background: #f1f5f9;
            cursor: pointer;
        }
        
        .payment-filter-btn.active {
            background: var(--primary);
            color: white;
        }
    </style>
</head>
<body class="min-h-screen text-gray-800">
    <!-- Pre-Login View -->
    <div id="pre-login-view">
        <header class="header-gradient py-6">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="text-center md:text-left mb-4 md:mb-0">
                        <h1 class="text-2xl md:text-3xl font-bold text-white">Hanagandi Karmic Sang</h1>
                        <p class="kannada-font text-white opacity-90 mt-1">ಹನಗಂಡಿ ಕಟ್ಟಡ ಮತ್ತು ಇತರೆ ನಿರ್ಮಾಣ ಕಾರ್ಮಿಕ ಸಂಘ</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right text-white">
                            <p class="font-semibold flex items-center">
                                <i class="fa-solid fa-phone mr-2"></i>Helpline
                            </p>
                            <a href="tel:9742611065" class="font-bold text-xl">9742611065</a>
                        </div>
                        <button id="show-login-modal-btn" class="btn-primary flex items-center">
                            <i class="fa-solid fa-right-to-bracket mr-2"></i>Admin Login
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-12">
            <div class="hero-section mb-16 rounded-2xl">
                <h2 class="text-4xl md:text-5xl font-extrabold mb-6">Empowering Construction Workers</h2>
                <p class="text-xl text-blue-100 mb-10 max-w-2xl mx-auto">
                    Join our union to secure your rights, get support, and be part of a strong community dedicated to improving working conditions.
                </p>
                <button id="show-registration-modal-btn" class="btn-secondary text-lg py-4 px-10">
                    <i class="fa-solid fa-user-plus mr-3"></i> Register for Membership
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16">
                <div class="feature-card card p-6">
                    <div class="text-blue-600 text-4xl mb-4">
                        <i class="fa-solid fa-shield-halved"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-3">Worker Protection</h3>
                    <p class="text-gray-600">We ensure fair wages, safe working conditions, and legal protection for all our members.</p>
                </div>
                <div class="feature-card card p-6">
                    <div class="text-blue-600 text-4xl mb-4">
                        <i class="fa-solid fa-hand-holding-medical"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-3">Healthcare Support</h3>
                    <p class="text-gray-600">Access to health insurance and medical facilities for you and your family.</p>
                </div>
                <div class="feature-card card p-6">
                    <div class="text-blue-600 text-4xl mb-4">
                        <i class="fa-solid fa-graduation-cap"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-3">Skill Development</h3>
                    <p class="text-gray-600">Training programs to enhance your skills and increase your earning potential.</p>
                </div>
            </div>

            <div class="bg-white card p-8 max-w-3xl mx-auto mb-16">
                <h3 class="text-2xl font-bold mb-6 text-center">Check Application Status</h3>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input 
                        type="text" 
                        id="status-check-input" 
                        placeholder="Enter Your Registration ID or Mobile Number..." 
                        class="form-control flex-grow p-4 rounded-xl"
                    >
                    <button id="status-check-btn" class="btn-primary px-8 py-4">
                        Check Status
                    </button>
                </div>
            </div>
        </main>

        <footer class="bg-gray-800 text-white py-8 mt-16">
            <div class="container mx-auto px-4 text-center">
                <p>© 2024 Hanagandi Karmic Sang. All rights reserved.</p>
                <p class="mt-2 text-gray-400">Building a stronger community for construction workers</p>
            </div>
        </footer>
    </div>

    <!-- Post-Login Admin Dashboard -->
    <div id="post-login-view" class="hidden">
        <div class="flex flex-col md:flex-row min-h-screen bg-gray-50">
            <!-- Sidebar -->
            <aside class="sidebar text-white w-full md:w-64 relative">
                <div class="p-6 border-b border-gray-700">
                    <h1 class="text-xl font-bold flex items-center">
                        <i class="fa-solid fa-gear mr-3"></i>Admin Panel
                    </h1>
                </div>
                <nav class="p-4 space-y-2">
                    <a href="#" data-view="dashboard" class="nav-item flex items-center active">
                        <i class="fa-solid fa-tachometer-alt mr-3"></i>Dashboard
                    </a>
                    <a href="#" data-view="members-list" class="nav-item flex items-center">
                        <i class="fa-solid fa-users mr-3"></i>Members List
                    </a>
                    <a href="#" data-view="pending-list" class="nav-item flex items-center">
                        <i class="fa-solid fa-user-clock mr-3"></i>Pending List
                    </a>
                    <a href="#" data-view="renewal-list" class="nav-item flex items-center">
                        <i class="fa-solid fa-calendar-day mr-3"></i>Membership Renewals
                    </a>
                    <a href="#" data-view="labour-renewal-list" class="nav-item flex items-center">
                        <i class="fa-solid fa-building-user mr-3"></i>Labour Dept Renewals
                    </a>
                    <a href="#" data-view="inactive-list" class="nav-item flex items-center">
                        <i class="fa-solid fa-user-slash mr-3"></i>Inactive Members
                    </a>
                    <a href="#" id="sidebar-id-card-btn" class="nav-item flex items-center">
                        <i class="fa-solid fa-id-card mr-3"></i>ID Card Generator
                    </a>
                    <a href="#" id="sidebar-receipt-btn" class="nav-item flex items-center">
                        <i class="fa-solid fa-receipt mr-3"></i>Receipt Generator
                    </a>
                    <a href="#" data-view="payment-records" class="nav-item flex items-center">
                        <i class="fa-solid fa-money-bill-wave mr-3"></i>Payment Records
                    </a>
                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-btn" class="w-full btn-primary py-3">
                        <i class="fa-solid fa-right-from-bracket mr-2"></i>Logout
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-6 overflow-y-auto">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view-section active">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-800">Dashboard</h1>
                        <div class="flex gap-4">
                            <button id="dashboard-add-member-btn" class="btn-secondary flex items-center">
                                <i class="fa-solid fa-user-plus mr-2"></i>Add New Member
                            </button>
                            <button id="refresh-dashboard-btn" class="refresh-btn flex items-center">
                                <i class="fa-solid fa-rotate mr-2"></i>Refresh
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="stat-card">
                            <div class="text-gray-600">Total Members</div>
                            <div id="total-members-stat" class="stat-number text-blue-600">0</div>
                            <div class="text-sm text-gray-500">Approved members</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-gray-600">Renewals Due (30 Days)</div>
                            <div id="renewals-due-stat" class="stat-number text-orange-500">0</div>
                            <div class="text-sm text-gray-500">Membership renewals</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-gray-600">Pending Approvals</div>
                            <div id="pending-approvals-stat" class="stat-number text-yellow-500">0</div>
                            <div class="text-sm text-gray-500">Awaiting approval</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="card p-6 lg:col-span-2">
                            <h3 class="text-xl font-semibold mb-4">Pending Approvals (Recent 5)</h3>
                            <div class="overflow-x-auto">
                                <table class="member-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Date</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pending-approvals-table">
                                        <!-- Will be populated dynamically -->
                                    </tbody>
                                </table>
                                <p id="no-pending-approvals" class="text-center text-gray-500 py-4 hidden">
                                    No pending approvals at this time.
                                </p>
                            </div>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4">Members by Work Type</h3>
                            <div id="work-type-stats" class="space-y-3 max-h-64 overflow-y-auto">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Members List View -->
                <div id="members-list-view" class="view-section hidden"></div>
                
                <!-- Pending List View -->
                <div id="pending-list-view" class="view-section hidden"></div>
                
                <!-- Membership Renewal List View -->
                <div id="renewal-list-view" class="view-section hidden"></div>

                <!-- Labour Dept Renewal List View -->
                <div id="labour-renewal-list-view" class="view-section hidden"></div>
                
                <!-- Inactive Members View -->
                <div id="inactive-list-view" class="view-section hidden"></div>
                
                <!-- Payment Records View -->
                <div id="payment-records-view" class="view-section hidden"></div>
            </main>
        </div>
    </div>

    <!-- Print Container -->
    <div class="print-container"></div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const { jsPDF } = window.jspdf;
        // --- DATA INITIALIZATION ---
        let db = { 
            members: [
                {
                    id: "HKKS01",
                    fullName: "Rajesh Kumar",
                    fatherHusbandName: "Suresh Kumar",
                    dob: "1985-05-15",
                    gender: "Male",
                    mobile: "9876543210",
                    emergencyContact: "8765432109",
                    address: "123 Main Street, Hanagandi",
                    officeAddress: "Union Office, Hanagandi",
                    aadhaar: "123456789012",
                    religionCaste: "Hindu",
                    bloodGroup: "B+",
                    workType: "Mason",
                    experience: "12",
                    docs: ["Aadhaar", "Labour"],
                    registrationDate: "2023-01-15",
                    membershipRenewalDate: "2024-01-15",
                    labourDeptRenewalDate: "2024-08-30",
                    status: "approved",
                    active: true,
                    photoData: "https://randomuser.me/api/portraits/men/32.jpg"
                },
                {
                    id: "HKKS02",
                    fullName: "Priya Sharma",
                    fatherHusbandName: "Vikram Sharma",
                    dob: "1990-08-22",
                    gender: "Female",
                    mobile: "8765432109",
                    emergencyContact: "7654321098",
                    address: "456 Oak Avenue, Rabkavi",
                    officeAddress: "Union Office, Hanagandi",
                    aadhaar: "234567890123",
                    religionCaste: "Hindu",
                    bloodGroup: "O+",
                    workType: "Electrician",
                    experience: "8",
                    docs: ["Aadhaar", "Bank"],
                    registrationDate: "2023-02-20",
                    membershipRenewalDate: "2024-02-20",
                    labourDeptRenewalDate: "2024-07-10",
                    status: "approved",
                    active: true,
                    photoData: "https://randomuser.me/api/portraits/women/44.jpg"
                },
                {
                    id: "HKKS03",
                    fullName: "Suresh Patel",
                    fatherHusbandName: "Ramesh Patel",
                    dob: "1978-11-05",
                    gender: "Male",
                    mobile: "7654321098",
                    emergencyContact: "6543210987",
                    address: "789 Pine Road, Banhatti",
                    officeAddress: "Union Office, Hanagandi",
                    aadhaar: "345678901234",
                    religionCaste: "Hindu",
                    bloodGroup: "A+",
                    workType: "Carpenter",
                    experience: "15",
                    docs: ["Aadhaar", "Voter"],
                    registrationDate: "2023-03-10",
                    membershipRenewalDate: "2024-03-10",
                    labourDeptRenewalDate: null,
                    status: "pending",
                    active: false,
                    photoData: "https://randomuser.me/api/portraits/men/22.jpg"
                }
            ], 
            receipts: [],
            payments: [
                {
                    id: "PAY001",
                    memberId: "HKKS01",
                    memberName: "Rajesh Kumar",
                    date: "2023-01-15",
                    amount: 500,
                    type: "registration",
                    receiptId: "REC001"
                },
                {
                    id: "PAY002",
                    memberId: "HKKS01",
                    memberName: "Rajesh Kumar",
                    date: "2024-01-15",
                    amount: 300,
                    type: "renewal",
                    receiptId: "REC002"
                },
                {
                    id: "PAY003",
                    memberId: "HKKS02",
                    memberName: "Priya Sharma",
                    date: "2023-02-20",
                    amount: 500,
                    type: "registration",
                    receiptId: "REC003"
                }
            ] 
        };

        const saveData = () => localStorage.setItem('karmicSangDb', JSON.stringify(db));
        const loadData = () => {
            const savedData = localStorage.getItem('karmicSangDb');
            if (savedData) {
                db = JSON.parse(savedData);
                db.members.forEach(m => {
                    if (m.renewalDate && !m.membershipRenewalDate) {
                        m.membershipRenewalDate = m.renewalDate;
                        delete m.renewalDate;
                    }
                });
                saveData();
            }
        };
        
        const preLoginView = document.getElementById('pre-login-view');
        const postLoginView = document.getElementById('post-login-view');
        const modalContainer = document.getElementById('modal-container');
        let stream = null;
        
        loadData();
        renderModals();
        
        function renderAll() {
            renderDashboard();
            renderMembersList();
            renderPendingList();
            renderRenewalList();
            renderLabourRenewalList();
            renderInactiveList();
            renderPaymentRecords();
        }
        
        function renderDashboard() {
            const approvedMembers = db.members.filter(m => m.status === 'approved');
            const pendingMembers = db.members.filter(m => m.status === 'pending');
            const now = new Date();
            const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);

            const renewalsDue = approvedMembers.filter(m => 
                m.active && m.membershipRenewalDate && new Date(m.membershipRenewalDate) <= thirtyDaysFromNow
            );
            
            document.getElementById('total-members-stat').textContent = approvedMembers.length;
            document.getElementById('pending-approvals-stat').textContent = pendingMembers.length;
            document.getElementById('renewals-due-stat').textContent = renewalsDue.length;
            
            const pendingTable = document.getElementById('pending-approvals-table');
            pendingTable.innerHTML = '';
            
            if (pendingMembers.length === 0) {
                document.getElementById('no-pending-approvals').classList.remove('hidden');
            } else {
                document.getElementById('no-pending-approvals').classList.add('hidden');
                pendingMembers.slice(0, 5).forEach(member => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="font-medium">${member.fullName}</td>
                        <td>${new Date(member.registrationDate).toLocaleDateString()}</td>
                        <td class="text-center">
                            <button data-id="${member.id}" class="action-approve approve-btn action-btn mr-2">Approve</button>
                            <button data-id="${member.id}" class="action-reject reject-btn action-btn">Reject</button>
                        </td>
                    `;
                    pendingTable.appendChild(row);
                });
            }

            const workTypeStatsEl = document.getElementById('work-type-stats');
            const workTypeCounts = approvedMembers.reduce((acc, member) => {
                const workType = member.workType || 'Unassigned';
                acc[workType] = (acc[workType] || 0) + 1;
                return acc;
            }, {});

            workTypeStatsEl.innerHTML = Object.entries(workTypeCounts).map(([type, count]) => `
                <div class="flex justify-between items-center text-sm">
                    <span class="text-gray-600">${type}</span>
                    <span class="font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded">${count}</span>
                </div>
            `).join('');
        }
        
        function renderMemberListView(viewId, title, members, noDataText, isMembershipRenewal = false) {
            const view = document.getElementById(`${viewId}-view`);
            if (!view) return;

            const tableBody = members.map(member => {
                const { badge, isExpired } = getMemberDisplayStatus(member);
                const renewalDate = member.membershipRenewalDate ? new Date(member.membershipRenewalDate).toLocaleDateString() : 'N/A';

                return `
                    <tr>
                        <td class="font-medium">${member.id}</td>
                        <td>${member.fullName}</td>
                        <td>${member.mobile}</td>
                        <td>${member.workType}</td>
                        <td>${renewalDate}</td>
                        <td class="text-center">${badge}</td>
                        <td class="text-center space-x-1">
                            <button data-id="${member.id}" class="action-view view-btn action-btn" title="View Details"><i class="fa-solid fa-eye"></i></button>
                            <button data-id="${member.id}" class="action-edit bg-yellow-500 text-white action-btn" title="Edit Member"><i class="fa-solid fa-pen-to-square"></i></button>
                            ${isMembershipRenewal && isExpired ? `<button data-id="${member.id}" class="action-renew renew-btn action-btn" title="Renew Membership"><i class="fa-solid fa-arrows-rotate"></i></button>` : ''}
                            <button data-id="${member.id}" class="action-delete bg-red-500 text-white action-btn" title="Delete Member"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');

            view.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">${title}</h1>
                    <div class="relative">
                        <input type="text" id="${viewId}-search" placeholder="Search by ID, Name, Mobile..." class="form-control w-64">
                        <i class="fa-solid fa-search absolute right-3 top-3.5 text-gray-400"></i>
                    </div>
                </div>
                <div class="card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="member-table">
                            <thead><tr><th>ID</th><th>Name</th><th>Mobile</th><th>Work Type</th><th>Membership Renewal</th><th class="text-center">Status</th><th class="text-center">Actions</th></tr></thead>
                            <tbody id="${viewId}-table-body">${tableBody || `<tr><td colspan="7" class="text-center py-6 text-gray-500">${noDataText}</td></tr>`}</tbody>
                        </table>
                    </div>
                </div>
            `;

            const searchInput = document.getElementById(`${viewId}-search`);
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = members.filter(m => 
                        m.id.toLowerCase().includes(term) || 
                        m.fullName.toLowerCase().includes(term) || 
                        m.mobile.includes(term)
                    );
                    
                    const newTableBody = filtered.map(member => {
                         const { badge, isExpired } = getMemberDisplayStatus(member);
                         const renewalDate = member.membershipRenewalDate ? new Date(member.membershipRenewalDate).toLocaleDateString() : 'N/A';
                         return `<tr>...</tr>`; // Full row HTML as above
                    }).join('');

                    document.getElementById(`${viewId}-table-body`).innerHTML = newTableBody || `<tr><td colspan="7" class="text-center py-6 text-gray-500">No members found.</td></tr>`;
                });
            }
        }
        
        function renderMembersList() { renderMemberListView('members-list', 'Active Members', db.members.filter(m => m.status === 'approved' && m.active), 'No active members found.'); }
        function renderPendingList() { renderMemberListView('pending-list', 'Pending Members', db.members.filter(m => m.status === 'pending'), 'No pending members.'); }
        function renderInactiveList() { renderMemberListView('inactive-list', 'Inactive Members', db.members.filter(m => !m.active), 'No inactive members.'); }
        
        function renderRenewalList() {
            const now = new Date();
            const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
            
            const renewalsDue = db.members.filter(m => {
                if (m.status !== 'approved' || !m.active) return false;
                const renewalDate = new Date(m.membershipRenewalDate);
                return renewalDate < thirtyDaysFromNow;
            });
            renderMemberListView('renewal-list', 'Membership Renewals Due or Expired', renewalsDue, 'No membership renewals due.', true);
        }

        function renderLabourRenewalList(filterMonth = null) {
            const view = document.getElementById('labour-renewal-list-view');
            const thirtyDaysFromNow = new Date(new Date().getTime() + 30 * 24 * 60 * 60 * 1000);

            let membersToList = db.members.filter(m => {
                if (m.status !== 'approved' || !m.labourDeptRenewalDate) return false;
                const renewalDate = new Date(m.labourDeptRenewalDate);
                if (filterMonth !== null) {
                    return renewalDate.getMonth() === filterMonth;
                }
                return renewalDate < thirtyDaysFromNow;
            });
            
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const monthFilters = `
                <div class="flex flex-wrap gap-2 mb-4">
                    <button class="month-filter-btn px-3 py-1 rounded ${filterMonth === null ? 'bg-blue-600 text-white' : 'bg-gray-200'}" data-month="all">All Due Soon</button>
                    ${months.map((m, i) => `<button class="month-filter-btn px-3 py-1 rounded ${filterMonth === i ? 'bg-blue-600 text-white' : 'bg-gray-200'}" data-month="${i}">${m}</button>`).join('')}
                </div>
            `;

            let tableBody = membersToList.map(m => `
                <tr>
                    <td>${m.fullName}</td>
                    <td>${new Date(m.labourDeptRenewalDate).toLocaleDateString()}</td>
                    <td class="text-center">
                        <input type="date" class="form-control w-auto inline-block" id="labour-renew-date-${m.id}">
                        <button data-id="${m.id}" class="action-update-labour-renew btn-primary px-3 py-2.5 text-sm ml-2">Update</button>
                    </td>
                </tr>
            `).join('');

            view.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Labour Dept. Renewals</h1>
                </div>
                ${monthFilters}
                <div class="card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="member-table">
                            <thead><tr><th>Name</th><th>Current Renewal Date</th><th class="text-center">Set New Renewal Date</th></tr></thead>
                            <tbody>${tableBody || `<tr><td colspan="3" class="text-center py-6 text-gray-500">No renewals found for this filter.</td></tr>`}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function renderPaymentRecords() {
            const view = document.getElementById('payment-records-view');
            if (!view) return;
            
            view.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Payment Records</h1>
                    <div class="relative">
                        <input type="text" id="payment-search" placeholder="Search by Member ID, Name..." class="form-control w-64">
                        <i class="fa-solid fa-search absolute right-3 top-3.5 text-gray-400"></i>
                    </div>
                </div>
                
                <div class="payment-filter-bar">
                    <button class="payment-filter-btn active" data-type="all">All Payments</button>
                    <button class="payment-filter-btn" data-type="registration">Registration Fees</button>
                    <button class="payment-filter-btn" data-type="renewal">Renewal Fees</button>
                </div>
                
                <div class="card overflow-hidden p-6">
                    <div class="space-y-4" id="payment-records-list">
                        ${db.payments.map(payment => `
                            <div class="payment-record">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="font-bold">${payment.memberName}</span>
                                        <span class="text-sm text-gray-600 ml-2">(${payment.memberId})</span>
                                    </div>
                                    <div>
                                        <span class="payment-type-badge ${payment.type === 'registration' ? 'payment-registration' : 'payment-renewal'}">
                                            ${payment.type === 'registration' ? 'Registration' : 'Renewal'}
                                        </span>
                                    </div>
                                </div>
                                <div class="flex justify-between mt-2">
                                    <div>
                                        <span class="text-gray-600">Date: </span>
                                        <span>${new Date(payment.date).toLocaleDateString()}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Amount: </span>
                                        <span class="font-bold">₹${payment.amount}</span>
                                    </div>
                                </div>
                                <div class="mt-2 text-right">
                                    <button data-id="${payment.receiptId}" class="action-view-receipt text-blue-600 hover:text-blue-800">
                                        <i class="fa-solid fa-file-invoice mr-1"></i>View Receipt
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                        
                        ${db.payments.length === 0 ? `<p class="text-center text-gray-500 py-6">No payment records found.</p>` : ''}
                    </div>
                </div>
            `;
            
            // Add event listeners for payment filtering
            document.querySelectorAll('.payment-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.payment-filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const type = this.dataset.type;
                    const searchTerm = document.getElementById('payment-search').value.toLowerCase();
                    
                    const filteredPayments = db.payments.filter(p => {
                        const matchesType = type === 'all' || p.type === type;
                        const matchesSearch = searchTerm === '' || 
                            p.memberId.toLowerCase().includes(searchTerm) || 
                            p.memberName.toLowerCase().includes(searchTerm);
                        return matchesType && matchesSearch;
                    });
                    
                    const paymentList = document.getElementById('payment-records-list');
                    paymentList.innerHTML = filteredPayments.map(payment => `
                        <div class="payment-record">
                            <!-- Payment record HTML as above -->
                        </div>
                    `).join('') || `<p class="text-center text-gray-500 py-6">No matching payments found.</p>`;
                });
            });
            
            // Add event listener for payment search
            document.getElementById('payment-search').addEventListener('input', function() {
                const term = this.value.toLowerCase();
                const activeFilter = document.querySelector('.payment-filter-btn.active').dataset.type;
                
                const filteredPayments = db.payments.filter(p => {
                    const matchesType = activeFilter === 'all' || p.type === activeFilter;
                    const matchesSearch = term === '' || 
                        p.memberId.toLowerCase().includes(term) || 
                        p.memberName.toLowerCase().includes(term);
                    return matchesType && matchesSearch;
                });
                
                const paymentList = document.getElementById('payment-records-list');
                paymentList.innerHTML = filteredPayments.map(payment => `
                    <div class="payment-record">
                        <!-- Payment record HTML as above -->
                    </div>
                `).join('') || `<p class="text-center text-gray-500 py-6">No matching payments found.</p>`;
            });
        }
        
        function getMemberDisplayStatus(member) {
            let badge = '';
            let isExpired = false;
            const now = new Date();
            
            if (member.status === 'pending') {
                badge = '<span class="status-badge status-pending">Pending</span>';
            } else if (!member.active) {
                badge = '<span class="status-badge status-inactive">Inactive</span>';
            } else if (member.membershipRenewalDate && new Date(member.membershipRenewalDate) < now) {
                badge = '<span class="status-badge status-expired">Expired</span>';
                isExpired = true;
            } else {
                badge = '<span class="status-badge status-approved">Active</span>';
            }
            return { badge, isExpired };
        }
        
        function createModal(id, title, content, maxWidth = 'max-w-md') {
            return `
                <div id="${id}" class="modal-overlay hidden">
                    <div class="modal-content ${maxWidth}">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h2 class="text-2xl font-bold">${title}</h2>
                            <button class="close-modal-btn text-gray-500 text-3xl">×</button>
                        </div>
                        <div class="p-6">${content}</div>
                    </div>
                </div>`;
        }

        function renderModals() {
            modalContainer.innerHTML = `
                ${createModal('login-modal', 'Admin Login', `
                    <form id="login-form">
                        <div class="mb-6">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" id="username" class="form-control" placeholder="Enter your username" required>
                        </div>
                        <div class="mb-6">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" id="password" class="form-control" placeholder="Enter your password" required>
                        </div>
                        <div id="invalid-login-alert" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 hidden">
                            <p>Invalid credentials. Please try again.</p>
                        </div>
                        <button type="submit" class="btn-primary w-full py-3">
                            <i class="fa-solid fa-right-to-bracket mr-2"></i>Login
                        </button>
                    </form>
                `)}
                
                ${createModal('registration-modal', 'New Member Registration', `
                    <form id="registration-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label required">Full Name</label>
                                <input type="text" name="fullName" class="form-control" required>
                            </div>
                            <div>
                                <label class="form-label">Father/Husband Name</label>
                                <input type="text" name="fatherHusbandName" class="form-control">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="form-label required">Date of Birth</label>
                                <input type="date" name="dob" class="form-control" required>
                            </div>
                            <div>
                                <label class="form-label required">Gender</label>
                                <select name="gender" class="form-control" required>
                                    <option value="">Select</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label required">Mobile Number</label>
                                <input type="tel" name="mobile" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label">Emergency Contact</label>
                                <input type="tel" name="emergencyContact" class="form-control">
                            </div>
                            <div>
                                <label class="form-label required">Work Type</label>
                                <select name="workType" class="form-control" required>
                                    <option value="">Select Work Type</option>
                                    <option value="Mason">Mason</option>
                                    <option value="Plumber">Plumber</option>
                                    <option value="Electrician">Electrician</option>
                                    <option value="Carpenter">Carpenter</option>
                                    <option value="Painter">Painter</option>
                                    <option value="Helper">Helper</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="form-label required">Address</label>
                            <textarea name="address" class="form-control" required></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label required">Aadhaar Number</label>
                                <input type="text" name="aadhaar" class="form-control" required>
                            </div>
                            <div>
                                <label class="form-label">Experience (Years)</label>
                                <input type="number" name="experience" class="form-control" min="0">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label required">Registration Date</label>
                                <input type="date" name="registrationDate" class="form-control" required>
                            </div>
                            <div>
                                <label class="form-label">Membership Renewal Date</label>
                                <input type="date" name="membershipRenewalDate" class="form-control">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label">Labour Dept. Registration Date</label>
                                <input type="date" name="labourDeptRegistrationDate" class="form-control">
                            </div>
                            <div>
                                <label class="form-label">Labour Dept. Renewal Date</label>
                                <input type="date" name="labourDeptRenewalDate" class="form-control">
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <div class="form-label">Upload Photo</div>
                            <div class="photo-upload-container">
                                <i class="fa-solid fa-cloud-arrow-up"></i>
                                <div class="upload-text">Click to upload photo</div>
                                <input type="file" id="photo-upload" accept="image/*" class="hidden">
                                <img id="photo-preview" class="photo-preview" alt="Preview">
                                <div class="photo-options">
                                    <button type="button" id="camera-btn" class="btn-secondary text-sm px-4 py-2">
                                        <i class="fa-solid fa-camera mr-1"></i>Take Photo
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-4 mt-8">
                            <button type="button" class="close-modal-btn bg-gray-300 text-gray-700 px-6 py-3 rounded-xl">Cancel</button>
                            <button type="submit" id="submit-registration-btn" class="btn-primary px-8 py-3">Submit</button>
                        </div>
                    </form>
                `, 'max-w-5xl')}
                
                ${createModal('status-check-modal', 'Application Status', `<div id="status-check-content"></div>`)}
                ${createModal('member-details-modal', 'Member Details', `<div id="member-details-content"></div>`, 'max-w-2xl')}
            `;
        }

        function openModal(id) { document.getElementById(id)?.classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id)?.classList.add('hidden'); }
        
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
            document.getElementById(`${viewId}-view`)?.classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.nav-item[data-view="${viewId}"]`)?.classList.add('active');

            const renderFunc = {
                'dashboard': renderDashboard, 'members-list': renderMembersList,
                'pending-list': renderPendingList, 'renewal-list': renderRenewalList,
                'labour-renewal-list': renderLabourRenewalList, 'inactive-list': renderInactiveList,
                'payment-records': renderPaymentRecords,
            };
            renderFunc[viewId]?.();
        }
        
        function findMember(term) {
            if (!term) return null;
            term = term.toLowerCase();
            return db.members.find(m => 
                m.id.toLowerCase() === term || 
                m.fullName.toLowerCase().includes(term) || 
                m.mobile.includes(term)
            );
        }

        function generateMemberId() {
            const prefix = "HKKS";
            const nextNum = db.members.length + 1;
            return `${prefix}${nextNum.toString().padStart(3, '0')}`;
        }

        function addNewMember(memberData) {
            const newId = generateMemberId();
            const today = new Date().toISOString().split('T')[0];
            
            const newMember = {
                id: newId,
                ...memberData,
                status: 'approved',
                active: true,
                registrationDate: memberData.registrationDate || today,
                membershipRenewalDate: memberData.membershipRenewalDate || getOneYearLater(),
                photoData: memberData.photoData || "https://randomuser.me/api/portraits/men/0.jpg"
            };
            
            db.members.push(newMember);
            saveData();
            
            // Add registration fee payment
            const paymentId = `PAY${(db.payments.length + 1).toString().padStart(3, '0')}`;
            const receiptId = `REC${(db.receipts.length + 1).toString().padStart(3, '0')}`;
            
            db.payments.push({
                id: paymentId,
                memberId: newId,
                memberName: newMember.fullName,
                date: today,
                amount: 500,
                type: "registration",
                receiptId: receiptId
            });
            
            db.receipts.push({
                id: receiptId,
                memberId: newId,
                date: today,
                amount: 500,
                description: "Registration Fee"
            });
            
            saveData();
            return newMember;
        }

        function getOneYearLater() {
            const date = new Date();
            date.setFullYear(date.getFullYear() + 1);
            return date.toISOString().split('T')[0];
        }

        // --- EVENT LISTENERS ---

        // Login Form Submission
        document.getElementById('login-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const alertEl = document.getElementById('invalid-login-alert');
            
            if (username === 'admin' && password === 'Nijam7najmin@') {
                preLoginView.classList.add('hidden');
                postLoginView.classList.remove('hidden');
                closeModal('login-modal');
                alertEl.classList.add('hidden');
                switchView('dashboard');
            } else {
                alertEl.classList.remove('hidden');
            }
        });

        // Registration Form Submission
        document.getElementById('registration-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const memberData = Object.fromEntries(formData.entries());
            
            // Add new member
            const newMember = addNewMember(memberData);
            
            alert(`New member added successfully!\nID: ${newMember.id}`);
            closeModal('registration-modal');
            renderAll();
        });

        // Main Click Event Delegation
        document.addEventListener('click', function(e) {
            const target = e.target.closest('button, a');
            if (!target) return;

            // Show Login Modal
            if (target.id === 'show-login-modal-btn') {
                e.preventDefault();
                openModal('login-modal');
            }
            
            // Show Registration Modal
            if (target.id === 'show-registration-modal-btn' || target.id === 'dashboard-add-member-btn') {
                e.preventDefault();
                openModal('registration-modal');
            }
            
            // Logout
            if (target.id === 'logout-btn') {
                if (confirm('Are you sure you want to logout?')) {
                    postLoginView.classList.add('hidden');
                    preLoginView.classList.remove('hidden');
                }
            }
            
            // Close Modal
            if (target.classList.contains('close-modal-btn')) {
                closeModal(target.closest('.modal-overlay').id);
            }

            // Sidebar Navigation
            if (target.matches('.nav-item')) {
                e.preventDefault();
                const viewId = target.dataset.view;
                if (viewId) switchView(viewId);
            }

            // Status Check Button
            if (target.id === 'status-check-btn') {
                const term = document.getElementById('status-check-input').value;
                const member = findMember(term);
                const contentDiv = document.getElementById('status-check-content');
                if (member) {
                    const { badge } = getMemberDisplayStatus(member);
                    contentDiv.innerHTML = `<div class="text-center p-4"><h3 class="text-xl font-bold mb-2">${member.fullName}</h3><p class="mb-4">ID: ${member.id}</p><p class="font-bold text-lg">Status: ${badge}</p></div>`;
                } else {
                    contentDiv.innerHTML = `<p class="text-center p-4 text-red-600">No application found.</p>`;
                }
                openModal('status-check-modal');
            }

            // Approve Button
            if (target.classList.contains('action-approve')) {
                const memberId = target.dataset.id;
                const member = db.members.find(m => m.id === memberId);
                if (member) {
                    member.status = 'approved';
                    member.active = true;
                    
                    // Set membership renewal to one year from today if not set
                    if (!member.membershipRenewalDate) {
                        const oneYearLater = new Date();
                        oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);
                        member.membershipRenewalDate = oneYearLater.toISOString().split('T')[0];
                    }
                    
                    saveData();
                    renderDashboard();
                    renderPendingList();
                    
                    alert(`${member.fullName} has been approved!`);
                }
            }

            // Reject Button
            if (target.classList.contains('action-reject')) {
                const memberId = target.dataset.id;
                const member = db.members.find(m => m.id === memberId);
                if (member && confirm(`Reject ${member.fullName}'s application?`)) {
                    member.status = 'rejected';
                    member.active = false;
                    saveData();
                    renderDashboard();
                    renderPendingList();
                    
                    alert(`${member.fullName} has been rejected.`);
                }
            }

            // Membership Renew Action
            if (target.classList.contains('action-renew')) {
                const memberId = target.dataset.id;
                const member = db.members.find(m => m.id === memberId);
                if (member && confirm(`Renew membership for ${member.fullName} for one year from today?`)) {
                    const newRenewalDate = new Date();
                    newRenewalDate.setFullYear(newRenewalDate.getFullYear() + 1);
                    member.membershipRenewalDate = newRenewalDate.toISOString().split('T')[0];
                    member.active = true;
                    saveData();
                    
                    // Add renewal fee payment
                    const paymentId = `PAY${(db.payments.length + 1).toString().padStart(3, '0')}`;
                    const receiptId = `REC${(db.receipts.length + 1).toString().padStart(3, '0')}`;
                    const today = new Date().toISOString().split('T')[0];
                    
                    db.payments.push({
                        id: paymentId,
                        memberId: memberId,
                        memberName: member.fullName,
                        date: today,
                        amount: 300,
                        type: "renewal",
                        receiptId: receiptId
                    });
                    
                    db.receipts.push({
                        id: receiptId,
                        memberId: memberId,
                        date: today,
                        amount: 300,
                        description: "Membership Renewal Fee"
                    });
                    
                    saveData();
                    
                    alert('Membership renewed successfully!');
                    renderAll();
                }
            }

            // Labour Dept Renewal Update
            if (target.classList.contains('action-update-labour-renew')) {
                const memberId = target.dataset.id;
                const newDate = document.getElementById(`labour-renew-date-${memberId}`).value;
                const member = db.members.find(m => m.id === memberId);
                if (member && newDate) {
                    member.labourDeptRenewalDate = newDate;
                    saveData();
                    alert(`Labour Dept. renewal date for ${member.fullName} updated.`);
                    renderLabourRenewalList(document.querySelector('.month-filter-btn.bg-blue-600')?.dataset.month || null);
                } else {
                    alert('Please select a valid date.');
                }
            }

            // Labour Dept Renewal Month Filter
            if (target.classList.contains('month-filter-btn')) {
                const month = target.dataset.month;
                renderLabourRenewalList(month === 'all' ? null : parseInt(month));
            }
            
            // Refresh Dashboard
            if (target.id === 'refresh-dashboard-btn') {
                renderDashboard();
            }
        });

        // Initialize first view if logged in
        if (postLoginView.classList.contains('hidden')) {
            // Not logged in
        } else {
            switchView('dashboard');
        }
        
        // Set current date as default for registration form dates
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const oneYearLater = getOneYearLater();
            
            if (document.querySelector('input[name="registrationDate"]')) {
                document.querySelector('input[name="registrationDate"]').value = today;
            }
            
            if (document.querySelector('input[name="membershipRenewalDate"]')) {
                document.querySelector('input[name="membershipRenewalDate"]').value = oneYearLater;
            }
        });
    });
    </script>
</body>
</html>